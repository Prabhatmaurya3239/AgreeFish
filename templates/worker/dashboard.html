{% extends 'base.html' %}

{% block title %}Worker Dashboard - AgriFish{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tools me-2"></i>Worker Dashboard</h2>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#availabilityModal">
                        <i class="fas fa-cog me-2"></i>Availability Settings
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Available Jobs</h6>
                            <h3 class="mb-0">{{ pending_bookings|length }}</h3>
                        </div>
                        <i class="fas fa-briefcase fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">My Jobs</h6>
                            <h3 class="mb-0">{{ my_bookings|length }}</h3>
                        </div>
                        <i class="fas fa-clipboard-list fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Rating</h6>
                            <h3 class="mb-0">{{ worker_profile.workerprofile.rating|floatformat:1 }}</h3>
                        </div>
                        <i class="fas fa-star fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Total Jobs</h6>
                            <h3 class="mb-0">{{ worker_profile.workerprofile.total_jobs }}</h3>
                        </div>
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Available Job Requests -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-briefcase me-2"></i>Available Job Requests</h5>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    {% if pending_bookings %}
                        {% for booking in pending_bookings %}
                            <div class="card mb-3 border-start border-primary border-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="card-title">{{ booking.service_type }}</h6>
                                            <p class="card-text">
                                                <small class="text-muted">
                                                    <i class="fas fa-map-marker-alt me-1"></i>{{ booking.farm_address|truncatechars:50 }}
                                                </small>
                                            </p>
                                            <p class="mb-2">
                                                <span class="badge bg-secondary">{{ booking.crop_type|title }}</span>
                                                <span class="badge bg-info">{{ booking.area_acres }} acres</span>
                                            </p>
                                        </div>
                                        <div class="text-end">
                                            <h5 class="text-success">â‚¹{{ booking.estimated_cost }}</h5>
                                            <small class="text-muted">{{ booking.created_at|timesince }} ago</small>
                                        </div>
                                    </div>
                                    
                                    {% if booking.disease_detection %}
                                    <div class="alert alert-warning alert-sm mt-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Disease detected: <strong>{{ booking.disease_detection.disease_detected }}</strong>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="d-flex gap-2 mt-3">
                                        <button class="btn btn-success btn-sm" onclick="acceptBooking({{ booking.id }})">
                                            <i class="fas fa-check me-1"></i>Accept
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#jobDetailsModal{{ booking.id }}">
                                            <i class="fas fa-info-circle me-1"></i>Details
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Job Details Modal -->
                            <div class="modal fade" id="jobDetailsModal{{ booking.id }}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Job Details</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <table class="table">
                                                <tr>
                                                    <td><strong>Farmer:</strong></td>
                                                    <td>{{ booking.farmer.user.get_full_name }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Service:</strong></td>
                                                    <td>{{ booking.service_type }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Crop:</strong></td>
                                                    <td>{{ booking.crop_type|title }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Area:</strong></td>
                                                    <td>{{ booking.area_acres }} acres</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Preferred Date:</strong></td>
                                                    <td>{{ booking.preferred_date|date:"M d, Y H:i" }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Address:</strong></td>
                                                    <td>{{ booking.farm_address }}</td>
                                                </tr>
                                                {% if booking.notes %}
                                                <tr>
                                                    <td><strong>Notes:</strong></td>
                                                    <td>{{ booking.notes }}</td>
                                                </tr>
                                                {% endif %}
                                            </table>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="button" class="btn btn-success" onclick="acceptBooking({{ booking.id }})">
                                                <i class="fas fa-check me-1"></i>Accept Job
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-briefcase fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No job requests available in your area</p>
                            <small class="text-muted">Check back later or expand your service radius</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- My Active Jobs -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clipboard-list me-2"></i>My Active Jobs</h5>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    {% if my_bookings %}
                        {% for booking in my_bookings %}
                            <div class="card mb-3 border-start border-success border-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="card-title">{{ booking.service_type }}</h6>
                                            <p class="card-text">
                                                <small class="text-muted">
                                                    <i class="fas fa-user me-1"></i>{{ booking.farmer.user.get_full_name }}
                                                </small>
                                            </p>
                                            <p class="mb-2">
                                                <span class="badge bg-{{ booking.status|yesno:'primary,success,warning' }}">
                                                    {{ booking.get_status_display }}
                                                </span>
                                                <span class="badge bg-info">{{ booking.area_acres }} acres</span>
                                            </p>
                                        </div>
                                        <div class="text-end">
                                            <h5 class="text-success">â‚¹{{ booking.estimated_cost }}</h5>
                                            <small class="text-muted">{{ booking.preferred_date|date:"M d" }}</small>
                                        </div>
                                    </div>
                                    
                                    {% if booking.status == 'accepted' %}
                                    <div class="d-flex gap-2 mt-3">
                                        <button class="btn btn-primary btn-sm" onclick="updateBookingStatus({{ booking.id }}, 'in_progress')">
                                            <i class="fas fa-play me-1"></i>Start Work
                                        </button>
                                    </div>
                                    {% elif booking.status == 'in_progress' %}
                                    <div class="d-flex gap-2 mt-3">
                                        <button class="btn btn-success btn-sm" onclick="updateBookingStatus({{ booking.id }}, 'completed')">
                                            <i class="fas fa-check me-1"></i>Mark Complete
                                        </button>
                                    </div>
                                    {% elif booking.status == 'completed' %}
                                    <div class="alert alert-success alert-sm mt-2">
                                        <i class="fas fa-check-circle me-1"></i>Job completed successfully!
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No active jobs</p>
                            <small class="text-muted">Accepted jobs will appear here</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Availability Settings Modal -->
<div class="modal fade" id="availabilityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Availability Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="availabilityForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="isAvailable" 
                                   {{ worker_profile.workerprofile.is_available|yesno:"checked," }}>
                            <label class="form-check-label" for="isAvailable">
                                Available for new jobs
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Service Radius (km)</label>
                        <input type="number" class="form-control" id="serviceRadius" 
                               value="{{ worker_profile.workerprofile.service_radius_km }}" min="5" max="100">
                    </div>
                    
                    <div class="mb-3">
                        <input type="number" class="form-control" id="hourlyRate" 
                               value="{{ worker_profile.workerprofile.hourly_rate }}" step="0.01" min="50">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateAvailability()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function acceptBooking(bookingId) {
    if (confirm('Are you sure you want to accept this job?')) {
        window.location.href = `/accept-booking/${bookingId}/`;
    }
}

function updateBookingStatus(bookingId, status) {
    const statusText = status === 'in_progress' ? 'start working on' : 'complete';
    
    if (confirm(`Are you sure you want to ${statusText} this job?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/update-booking/${bookingId}/`;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = status;
        form.appendChild(statusInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function updateAvailability() {
    // In a real app, this would make an AJAX request to update availability
    alert('Availability settings updated successfully!');
    $('#availabilityModal').modal('hide');
}
</script>
{% endblock %}